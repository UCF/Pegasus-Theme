<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Canvas Maze Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        overflow: hidden;
        padding: 0;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <header>
    </header>
    <nav> </nav>
    <section>
      <div>
        <canvas id="canvas" width="628" height="842">
          This text is displayed if your browser does not support HTML5 Canvas.
        </canvas>
      </div>
    </section>
    <aside> </aside>
    <footer> </footer>
    <script type="text/javascript">
      var
        canvas,
        ctx,
        movement = 5,
        x = 32,
        y = 10,
        WIDTH = 628,
        HEIGHT = 842,
        bg = new Image(),
        collision = 0,
        isDragging = false,
        hitboxWidth = 5,
        hitboxHeight = 5,
        won = false,
        pegasusImage = null;

      function draw() {
        ctx.drawImage(bg, 0, 0);
        // ctx.fillStyle = "purple";
        // rect(x, y, hitboxWidth, hitboxHeight);
        pegasusImage = new Image();
        pegasusImage.src = "/wp-content/themes/Pegasus-Theme/dev/2016/spring/maze/pegasusSmall.png";
        pegasusImage.addEventListener('load', drawImage);
      }

      function drawImage() {
        ctx.drawImage(pegasusImage, x, y);
      }

      function rect(x, y, w, h) {
        ctx.beginPath();
        ctx.rect(x, y, w, h);
        ctx.closePath();
        ctx.fill();
      }

      function move(moveX, moveY) {
        x += moveX;
        y += moveY;
      }

      function doKeyDown(e){
        switch (e.keyCode) {
          case 38:  // Up arrow was pressed
            if (!checkcollision(0, -movement)) {
              move(0, -movement);
            }
            break;
          case 40:  // Down arrow was pressed
            if (!checkcollision(0, movement)) {
              move(0, movement);
            }
            break;
          case 37:  // Left arrow was pressed
            if (!checkcollision(-movement, 0)) {
              move(-movement, 0);
            }
            break;
          case 39:  // Right arrow was pressed
            if (!checkcollision(movement, 0)) {
              move(movement, 0);
            }
            break;
        }
        checkWin();
      }

      function handleMouseDown(){
        // set the drag flag
        isDragging = true;
      }

      function handleMouseUp(){
        // user has left the canvas, so clear the drag flag
        isDragging = false;
      }

      function handleMouseMove(e){
        if (isDragging) {
          newX = parseInt((e.clientX || e.changedTouches[0].clientX), 10);
          newY = parseInt((e.clientY || e.changedTouches[0].clientY), 10);

          // Determine the direction the player is moving
          if (newY < y && y - movement > 0 && !checkcollision(0, -movement)) {
            // Up
            move(0, -movement);
          }
          if (newY > y && y + movement < HEIGHT && !checkcollision(0, movement)) {
            // Down
            move(0, movement);
          }
          if (newX < x && x - movement > 0 && !checkcollision(-movement, 0)) {
            // Left
            move(-movement, 0);
          }
          if (newX > x && x + movement < WIDTH && !checkcollision(movement, 0)) {
            // Right
            move(movement, 0);
          }

          checkWin();
        }
      }


      function checkcollision(moveX, moveY) {
        var imgd = ctx.getImageData(x + moveX, y + moveY, hitboxWidth, hitboxHeight);
        var pix = imgd.data;
        // Modified to check GREEN channel instead of BLACK (every 2nd value)
        for (var i = 1; n = pix.length, i < n; i += 4) {
          if (pix[i] < 255) {
            return true;
          }
        }
        return false;
      }

      function checkWin() {
        if (x >= 622 && y > 797 && y < 808 && !won) {
          // TODO: what should happen when the user wins?
          alert('Winner winner chicken dinner!');
          won = true;
        }
      }

      function init() {
        canvas = document.getElementById("canvas");
        ctx = canvas.getContext("2d");
        bg.src = "maze.png";
        return setInterval(draw, 10);
      }

      init();
      document.addEventListener('touchmove', function(e) { e.preventDefault(); });
      window.addEventListener('keydown', doKeyDown, true);
      canvas.addEventListener('mousedown', handleMouseDown, false);
      canvas.addEventListener('mousemove', handleMouseMove, true);
      canvas.addEventListener('mouseup', handleMouseUp, false);
      canvas.addEventListener('touchstart', handleMouseDown, false);
      canvas.addEventListener('touchmove', handleMouseMove, true);
      canvas.addEventListener('touchend', handleMouseUp, false);
      canvas.addEventListener('touchcancel', handleMouseUp, false);
    </script>
  </body>
</html>
